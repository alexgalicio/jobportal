{% extends 'main/base.html' %}
{% load custom_filters %}

{% block title %}Title{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="container my-4">
    <div class="mb-4">
      <form method="get">
        <!-- search -->
        <div class="search-wrapper rounded d-flex align-items-center gap-2 mb-4">
          <div class="flex-grow-1">
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-search"></i></span>
              <input type="text" class="form-control" id="search" name="search" value="{{ search_query }}"
                placeholder="Job title, keywords, or company">
            </div>
          </div>
          <div class="divider"></div>
          <div class="flex-grow-1">
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-geo-alt"></i></span>
              <input type="text" class="form-control" id="location" name="location" value="{{ location_query }}"
                placeholder="City, province, or zip code">
            </div>
          </div>
          <button type="submit" class="btn btn-primary search-btn rounded">Find job</button>
        </div>

        <!-- filter -->
        <div class="row g-2">
          <div class="col-auto">
            <div class="filter-dropdown">
              <select class="form-select form-select-sm" id="workplace" name="workplace" onchange="this.form.submit()">
                <option value="">Workplace type</option>
                <option value="onsite" {% if workplace_query == 'onsite' %}selected{% endif %}>On-site</option>
                <option value="hybrid" {% if workplace_query == 'hybrid' %}selected{% endif %}>Hybrid</option>
                <option value="remote" {% if workplace_query == 'remote' %}selected{% endif %}>Remote</option>
              </select>
            </div>
          </div>
          <div class="col-auto">
            <div class="filter-dropdown">
              <select class="form-select form-select-sm" id="work_type" name="work_type" onchange="this.form.submit()">
                <option value="">Job type</option>
                <option value="internship" {% if work_type_query == 'internship' %}selected{% endif %}>Internship</option>
                <option value="full" {% if work_type_query == 'full' %}selected{% endif %}>Full-time</option>
                <option value="part" {% if work_type_query == 'part' %}selected{% endif %}>Part-time</option>
                <option value="contract" {% if work_type_query == 'contract' %}selected{% endif %}>Contract</option>
                <option value="casual" {% if work_type_query == 'casual' %}selected{% endif %}>Casual</option>
              </select>
            </div>
          </div>
          <div class="col-auto">
            <select class="form-select form-select-sm" name="date_posted" onchange="this.form.submit()">
              <option value="">Date posted</option>
              <option value="today" {% if date_posted == 'today' %}selected{% endif %}>Today</option>
              <option value="3days" {% if date_posted == '3days' %}selected{% endif %}>Last 3 days</option>
              <option value="7days" {% if date_posted == '7days' %}selected{% endif %}>Last 7 days</option>
              <option value="14days" {% if date_posted == '14days' %}selected{% endif %}>Last 14 days</option>
              <option value="30days" {% if date_posted == '30days' %}selected{% endif %}>Last 30 days</option>
            </select>
          </div>

          {% if search_query or location_query or workplace_query or work_type_query or date_posted %}
          <div class="col-auto">
            <a href="?" class="btn btn-link text-decoration-none btn-sm">Clear filters</a>
          </div>
          {% endif %}
        </div>
      </form>
    </div>

    <!-- results title -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="h4 mb-0">
        {% if jobs %}
        {{ jobs|length }} job{{ jobs|pluralize }} found
        {% else %}
        No jobs found
        {% endif %}
      </h2>
    </div>

    <!-- job listing -->
    <div class="row mb-5">
      <div class="{% if jobs %}col-lg-5 {% else %}col-lg-12 full-height{% endif %}">
        {% for job in jobs.object_list %}
        <!-- job card -->
        <div class="card job-card mb-3" onclick="showJob({{ job.id }})">
          <div class="card-body">
            <div class="d-flex justify-content-between mb-1">
              <div>
                <h5 class="card-title mb-1">{{ job.title }}</h5>
                <p class="mb-2">{{ job.employer.userprofile.employerprofile.company_name }}</p>
              </div>
              {% if job.employer.userprofile.employerprofile.logo %}
              <img src="{{ job.employer.userprofile.employerprofile.logo.url }}" alt="Logo"
                class="rounded company-logo">
              {% endif %}
            </div>
            <p class="mb-0">{{ job.location }}</p>
            <p>â‚±{{ job.pay_min|format_salary }}-{{ job.pay_max|format_salary }} per month</p>

            <!-- save button -->
            <div class="d-flex align-items-center justify-content-between">
              <p class="text-muted mb-0">{{ job.created_at|time_ago }}</p>
              {% if user.is_authenticated %}
              <button class="btn btn-link p-0" onclick="event.stopPropagation(); toggleSave({{ job.id }}, this)"
                title="Save job">
                {% if job.id in saved_jobs %}
                <i class="bi bi-bookmark-fill text-primary fs-4"></i>
                {% else %}
                <i class="bi bi-bookmark fs-4"></i>
                {% endif %}
              </button>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- empty state -->
        {% empty %}
        <div class="d-flex flex-column justify-content-center align-items-center text-center mnm-height">
          <i class="bi bi-briefcase text-muted fs-1"></i>
          <h4 class="mt-3 text-muted">No jobs found</h4>
          <p class="text-muted">Try adjusting your search or filters</p>
        </div>
        {% endfor %}

        <!-- pagination -->
        {% if jobs.has_other_pages %}
        <nav class="mt-3">
          <ul class="pagination">
            {% if jobs.has_previous %}
            <li class="page-item">
              <a class="page-link"
                href="?page={{ jobs.previous_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Previous</a>
            </li>
            {% endif %}
            {% for i in jobs.paginator.page_range %}
            <li class="page-item {% if jobs.number == i %}active{% endif %}">
              <a class="page-link"
                href="?page={{ i }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{
                i }}</a>
            </li>
            {% endfor %}
            {% if jobs.has_next %}
            <li class="page-item">
              <a class="page-link"
                href="?page={{ jobs.next_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Next</a>
            </li>
            {% endif %}
          </ul>
        </nav>
        {% endif %}
      </div>

      {% if jobs %}
      <!-- job details sidebar -->
      <div class="col-lg-7">
        <div class="card sticky-top" style="top: 20px;">
          <div class="card-body">
            <div id="job-details">
              <div class="text-center text-muted py-5">
                <p>Select a job to view details</p>
              </div>
            </div>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}